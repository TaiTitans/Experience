
---
Consumer Group lÃ  má»™t trong nhá»¯ng cÆ¡ cháº¿ quan trá»ng giÃºp Kafka **scale horizontally** vÃ  Ä‘áº£m báº£o **fault tolerance** khi xá»­ lÃ½ message.

## ğŸ”¹ **1. Consumer Group LÃ  GÃ¬?**

- Má»™t **Consumer Group** gá»“m nhiá»u **consumer** cÃ¹ng Ä‘á»c dá»¯ liá»‡u tá»« má»™t topic.
- Kafka **tá»± Ä‘á»™ng phÃ¢n phá»‘i partitions** giá»¯a cÃ¡c consumer trong group.
- **Má»—i partition chá»‰ cÃ³ duy nháº¥t má»™t consumer trong group Ä‘á»c dá»¯ liá»‡u.**

ğŸ“Œ **CÃ´ng thá»©c:**

> _Sá»‘ lÆ°á»£ng Consumer â‰¤ Sá»‘ lÆ°á»£ng Partitions_  
> Náº¿u sá»‘ Consumer **lá»›n hÆ¡n** sá»‘ Partition â†’ Má»™t sá»‘ Consumer sáº½ khÃ´ng nháº­n message.  
> Náº¿u sá»‘ Consumer **nhá» hÆ¡n** sá»‘ Partition â†’ Má»™t Consumer cÃ³ thá»ƒ xá»­ lÃ½ nhiá»u Partition.

## ğŸ”¹ **2. CÃ¡ch Kafka Load Balancing Consumer**

- **Kafka tá»± Ä‘á»™ng phÃ¢n bá»• partitions** giá»¯a cÃ¡c consumer trong group.
- Khi má»™t consumer **thoÃ¡t khá»i group**, Kafka sáº½ **redistribute partitions** cho cÃ¡c consumer cÃ²n láº¡i.
- **Má»—i partition chá»‰ cÃ³ má»™t consumer trong group Ä‘á»c dá»¯ liá»‡u.**

ğŸ“Œ **VÃ­ dá»¥ vá» Load Balancing**:

| **Sá»‘ Partition** | **Sá»‘ Consumer** | **PhÃ¢n bá»• Partition**                                |
| ---------------- | --------------- | ---------------------------------------------------- |
| 4                | 2               | Consumer 1 â†’ 2 partitions, Consumer 2 â†’ 2 partitions |
| 4                | 4               | Má»—i Consumer nháº­n 1 partition                        |
| 4                | 6               | 2 Consumer dÆ° thá»«a, khÃ´ng nháº­n dá»¯ liá»‡u               |

ğŸ”¥ **Khi Consumer tÄƒng â†’ Tá»± Ä‘á»™ng chia láº¡i load. Khi Consumer giáº£m â†’ Kafka tá»± Ä‘á»™ng cÃ¢n báº±ng láº¡i.**
## ğŸ”¹ **3. Consumer Group Äáº£m Báº£o Fault Tolerance NhÆ° Tháº¿ NÃ o?**

- Náº¿u má»™t **Consumer bá»‹ crash**, Kafka sáº½ **chuyá»ƒn partitions** cá»§a nÃ³ sang Consumer khÃ¡c trong nhÃ³m.
- Kafka **dá»±a vÃ o Heartbeat** Ä‘á»ƒ kiá»ƒm tra Consumer cÃ²n hoáº¡t Ä‘á»™ng hay khÃ´ng.
- Khi cÃ³ thay Ä‘á»•i vá» Consumer (thÃªm/xÃ³a Consumer), Kafka **trigger quÃ¡ trÃ¬nh Rebalance**.

ğŸ“Œ **VÃ­ dá»¥ vá» Fault Tolerance**:

1. Ban Ä‘áº§u, cÃ³ **3 Consumer (C1, C2, C3) Ä‘á»c tá»« 3 partitions (P1, P2, P3)**.
2. Náº¿u **C2 bá»‹ crash**, Kafka sáº½ **redistribute** partitions cá»§a C2 cho C1 hoáº·c C3.

ğŸ”¥ **KhÃ´ng cÃ³ message nÃ o bá»‹ máº¥t, Kafka chá»‰ thay Ä‘á»•i ai lÃ  ngÆ°á»i Ä‘á»c dá»¯ liá»‡u!**

## ğŸ”¹ **4. CÃ¡ch Kafka PhÃ¢n Phá»‘i Partitions Trong Consumer Group**

### âœ… **Round-Robin Assignment**

- Máº·c Ä‘á»‹nh, Kafka gÃ¡n **tuáº§n tá»± partitions cho consumer**.
- Náº¿u cÃ³ **6 partitions, 3 consumer**, Kafka gÃ¡n:
    - **C1 â†’ P1, P4**
    - **C2 â†’ P2, P5**
    - **C3 â†’ P3, P6**

### âœ… **Sticky Assignment (Kafka 2.4+)**

- Giá»¯ nguyÃªn **phÃ¢n phá»‘i cÅ©**, chá»‰ thay Ä‘á»•i khi cáº§n thiáº¿t Ä‘á»ƒ giáº£m **Rebalancing Cost**.

### âœ… **Range Assignment**

- Kafka chia partitions **theo khoáº£ng (range)** dá»±a trÃªn sá»‘ lÆ°á»£ng Consumer.

ğŸ”¥ **CÃ¡c thuáº­t toÃ¡n nÃ y giÃºp Kafka scale mÃ  váº«n tá»‘i Æ°u hiá»‡u suáº¥t xá»­ lÃ½ dá»¯ liá»‡u.**


