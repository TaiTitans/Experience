
---
# **CÆ¡ Cháº¿ Partitioning & Replication Trong Kafka**

Kafka Ä‘áº£m báº£o **High Availability (HA)** vÃ  **scalability** báº±ng cÃ¡ch **chia nhá» dá»¯ liá»‡u (partitioning)** vÃ  **sao chÃ©p dá»¯ liá»‡u (replication)** giá»¯a cÃ¡c broker.

## âœ… **1. Leader â€“ Follower: Kafka Äáº£m Báº£o HA NhÆ° Tháº¿ NÃ o?**

### ğŸ”¹ **Partitioning - Chia nhá» dá»¯ liá»‡u Ä‘á»ƒ scale**

- Má»—i **topic** trong Kafka Ä‘Æ°á»£c chia thÃ nh **nhiá»u partition**.
- Má»—i partition **chá»‰ náº±m trÃªn má»™t broker táº¡i má»™t thá»i Ä‘iá»ƒm**.
- **Producer gá»­i message vÃ o partition**, vÃ  **consumer Ä‘á»c dá»¯ liá»‡u tá»« partition Ä‘Ã³**.

ğŸ“Œ **VÃ­ dá»¥ vá» Kafka partitioning**:
```bash
Topic "orders":
  â”œâ”€â”€ Partition-0 (Broker 1)
  â”œâ”€â”€ Partition-1 (Broker 2)
  â”œâ”€â”€ Partition-2 (Broker 3)
```

ğŸ”¥ **Lá»£i Ã­ch cá»§a partitioning:**

- **Scale horizontally**: Khi cáº§n xá»­ lÃ½ nhiá»u dá»¯ liá»‡u, chá»‰ cáº§n **thÃªm partition**.
- **TÄƒng throughput**: Producer vÃ  consumer cÃ³ thá»ƒ **gá»­i/Ä‘á»c song song tá»« nhiá»u partition**.

### ğŸ”¹ **Replication - Sao chÃ©p dá»¯ liá»‡u Ä‘á»ƒ Ä‘áº£m báº£o HA**

- Kafka **sao chÃ©p má»—i partition** thÃ nh nhiá»u báº£n copy (replica).
- **Má»™t partition sáº½ cÃ³ 1 leader vÃ  nhiá»u follower**.
- **Leader** nháº­n ghi tá»« Producer, **follower** chá»‰ Ä‘á»c Ä‘á»ƒ Ä‘á»“ng bá»™ dá»¯ liá»‡u.

ğŸ“Œ **VÃ­ dá»¥: Replication Factor = 3**
```
Partition-0:
  â”œâ”€â”€ Leader (Broker 1)
  â”œâ”€â”€ Follower (Broker 2)
  â”œâ”€â”€ Follower (Broker 3)
```
ğŸ”¥ **Lá»£i Ã­ch cá»§a replication:**

- Náº¿u **leader bá»‹ down**, má»™t **follower sáº½ trá»Ÿ thÃ nh leader má»›i**.
- Äáº£m báº£o dá»¯ liá»‡u **khÃ´ng bá»‹ máº¥t (fault tolerance)**.

## âœ… **2. ISR (In-Sync Replicas) & ACK (Acknowledgment) Trong Producer**

### ğŸ”¹ **ISR (In-Sync Replicas)**

- ISR lÃ  danh sÃ¡ch **replica theo ká»‹p leader**.
- Náº¿u má»™t replica bá»‹ cháº­m, nÃ³ sáº½ bá»‹ **loáº¡i khá»i ISR**.
- Kafka chá»‰ chá»n **leader má»›i tá»« ISR** Ä‘á»ƒ Ä‘áº£m báº£o dá»¯ liá»‡u khÃ´ng bá»‹ máº¥t.

ğŸ“Œ **VÃ­ dá»¥ vá» ISR**:
```
Partition-0:
  â”œâ”€â”€ Leader (Broker 1) âœ…
  â”œâ”€â”€ Follower (Broker 2) âœ… (in-sync)
  â”œâ”€â”€ Follower (Broker 3) âŒ (out-of-sync)
```
ğŸ”¥ Náº¿u **Broker 1 (leader) bá»‹ down**, Kafka sáº½ chá»n **Broker 2 lÃ m leader má»›i**.

### ğŸ”¹ **ACK (Acknowledgment) cá»§a Producer**

Kafka cho phÃ©p Producer kiá»ƒm soÃ¡t má»©c Ä‘á»™ **Ä‘áº£m báº£o ghi dá»¯ liá»‡u** báº±ng tham sá»‘ `acks`.

|**acks**|**Ã nghÄ©a**|
|---|---|
|`acks=0`|Producer **khÃ´ng cáº§n leader xÃ¡c nháº­n**, nhanh nhÆ°ng **dá»… máº¥t dá»¯ liá»‡u**.|
|`acks=1`|**Leader xÃ¡c nháº­n**, nhanh hÆ¡n nhÆ°ng **máº¥t dá»¯ liá»‡u náº¿u leader down ngay sau khi nháº­n**.|
|`acks=all`|**Leader & táº¥t cáº£ ISR xÃ¡c nháº­n**, cháº­m hÆ¡n nhÆ°ng **an toÃ n nháº¥t**.|

ğŸ“Œ **Cáº¥u hÃ¬nh Producer vá»›i `acks=all` Ä‘á»ƒ Ä‘áº£m báº£o dá»¯ liá»‡u khÃ´ng bá»‹ máº¥t:**
```
acks=all
```

ğŸ”¥ **Chá»n `acks=all` Ä‘á»ƒ Ä‘áº£m báº£o dá»¯ liá»‡u an toÃ n, nhÆ°ng Ä‘Ã¡nh Ä‘á»•i báº±ng hiá»‡u suáº¥t.**

## âœ… **3. Tuning Partition Äá»ƒ TÄƒng Hiá»‡u Suáº¥t**

### ğŸ”¹ **CÃ¡ch chá»n sá»‘ lÆ°á»£ng partition há»£p lÃ½?**

- Sá»‘ lÆ°á»£ng partition áº£nh hÆ°á»Ÿng lá»›n Ä‘áº¿n hiá»‡u suáº¥t Kafka.
- CÃ´ng thá»©c Æ°á»›c lÆ°á»£ng partition:
```
Partition = Throughput cáº§n thiáº¿t (MB/s) / Throughput má»—i partition (MB/s)
```
- Náº¿u **quÃ¡ Ã­t partition**, producer/consumer sáº½ bá»‹ **bottleneck**.
- Náº¿u **quÃ¡ nhiá»u partition**, Kafka bá»‹ **overhead quáº£n lÃ½**.

ğŸ“Œ **Cáº¥u hÃ¬nh Kafka Ä‘á»ƒ tá»‘i Æ°u partition:**
```
num.partitions=6   # Sá»‘ partition máº·c Ä‘á»‹nh khi táº¡o topic
replication.factor=3  # Äáº£m báº£o fault tolerance
```

### ğŸ”¹ **Tá»‘i Æ°u leader balance giá»¯a cÃ¡c broker**

- TrÃ¡nh Ä‘á»ƒ **má»™t broker lÃ m leader quÃ¡ nhiá»u partition**.
- DÃ¹ng **Kafka Rebalancer** Ä‘á»ƒ tá»± Ä‘á»™ng cÃ¢n báº±ng leader:
```
kafka-preferred-replica-election.sh --bootstrap-server localhost:9092
```

