

---
## ğŸ”¥ **Kafka LÆ°u Trá»¯ Dá»¯ Liá»‡u TrÃªn Disk NhÆ° Tháº¿ NÃ o?**

Kafka **khÃ´ng lÆ°u trá»¯ dá»¯ liá»‡u trong RAM** nhÆ° Redis mÃ  lÆ°u trá»¯ **trÃªn disk** báº±ng **log-based storage**. Tuy nhiÃªn, nhá» **page cache cá»§a OS**, Kafka váº«n cÃ³ tá»‘c Ä‘á»™ truy xuáº¥t dá»¯ liá»‡u ráº¥t nhanh, gáº§n nhÆ° Ä‘á»c tá»« RAM.

## âœ… **1. Log Segments trong Kafka**

### ğŸ”¹ **Log Structure**

- Má»—i **topic** trong Kafka gá»“m nhiá»u **partition**.
- Má»—i **partition** lÃ  má»™t **log file** gá»“m nhiá»u **log segments**.
- **Producer ghi message tuáº§n tá»± vÃ o cuá»‘i file log** (append-only log).

ğŸ“Œ **Cáº¥u trÃºc thÆ° má»¥c lÆ°u trá»¯ dá»¯ liá»‡u trong Kafka**:
```bash
/kafka-logs/
  â”œâ”€â”€ topic-A/
  â”‚    â”œâ”€â”€ 0/
  â”‚    â”‚    â”œâ”€â”€ 00000000000000000000.log
  â”‚    â”‚    â”œâ”€â”€ 00000000000000000000.index
  â”‚    â”‚    â”œâ”€â”€ 00000000000000000000.timeindex
  â”‚    â”‚    â”œâ”€â”€ 00000000000000001000.log
  â”‚    â”‚    â”œâ”€â”€ 00000000000000001000.index
  â”‚    â”‚    â”œâ”€â”€ 00000000000000001000.timeindex
```
ğŸ”¥ **Má»—i partition lÃ  má»™t file log lá»›n, chia thÃ nh nhiá»u segment file Ä‘á»ƒ dá»… quáº£n lÃ½!**

### ğŸ”¹ **Log Segments**

- Kafka **chia nhá» log thÃ nh nhiá»u segment file** Ä‘á»ƒ tá»‘i Æ°u ghi vÃ  xÃ³a.
- Má»—i segment file cÃ³ **kÃ­ch thÆ°á»›c cá»‘ Ä‘á»‹nh** (`log.segment.bytes`, máº·c Ä‘á»‹nh 1GB).
- Khi má»™t segment Ä‘áº§y, Kafka sáº½ **má»Ÿ má»™t segment má»›i**.
- CÃ¡c segment cÅ© sáº½ Ä‘Æ°á»£c **xÃ³a hoáº·c compact** theo **Retention Policy**.
## âœ… **2. Offset trong Kafka**

### ğŸ”¹ **Offset lÃ  gÃ¬?**

- **Offset** lÃ  sá»‘ thá»© tá»± cá»§a message trong **partition**, giÃºp consumer biáº¿t Ä‘ang Ä‘á»c Ä‘áº¿n Ä‘Ã¢u.
- Offset **lÃ  duy nháº¥t trong má»—i partition**, khÃ´ng pháº£i toÃ n cá»¥c.

ğŸ“Œ VÃ­ dá»¥:
```bash
Partition-0: [offset=0] [offset=1] [offset=2] ...
Partition-1: [offset=0] [offset=1] [offset=2] ...
```

- **Producer khÃ´ng quan tÃ¢m offset** â†’ Kafka tá»± tÄƒng offset khi ghi dá»¯ liá»‡u.
- **Consumer cÃ³ thá»ƒ commit offset** Ä‘á»ƒ Kafka biáº¿t consumer Ä‘Ã£ xá»­ lÃ½ Ä‘áº¿n Ä‘Ã¢u.

## âœ… **3. Log Compaction**

### ğŸ”¹ **Táº¡i sao cáº§n Log Compaction?**

- Theo máº·c Ä‘á»‹nh, Kafka lÆ°u dá»¯ liá»‡u dá»±a vÃ o **thá»i gian (Retention Policy)**.
- NhÆ°ng vá»›i **log compaction**, Kafka cÃ³ thá»ƒ **giá»¯ láº¡i báº£n ghi má»›i nháº¥t cá»§a má»—i key** thay vÃ¬ xÃ³a theo thá»i gian.

ğŸ“Œ **VÃ­ dá»¥ vá» Log Compaction**:

|Offset|Key|Value|
|---|---|---|
|0|A|V1|
|1|B|V1|
|2|A|V2|
|3|C|V1|

**ğŸ”¥ Dá»¯ liá»‡u cÅ© cá»§a key "A" sáº½ bá»‹ xÃ³a Ä‘á»ƒ giáº£m dung lÆ°á»£ng.**

**Cáº¥u hÃ¬nh Log Compaction**:
```
log.cleanup.policy=compact
```

## âœ… **4. Retention Policy - CÆ¡ cháº¿ xÃ³a dá»¯ liá»‡u trong Kafka**

### ğŸ”¹ **Kafka xÃ³a dá»¯ liá»‡u nhÆ° tháº¿ nÃ o?**

Kafka **khÃ´ng xÃ³a message ngay sau khi consumer Ä‘á»c xong**.  
Dá»¯ liá»‡u chá»‰ bá»‹ xÃ³a theo **Retention Policy**, giÃºp Kafka xá»­ lÃ½ **replay & recovery** dá»… dÃ ng.

### ğŸ”¹ **CÃ³ 2 loáº¡i Retention Policy:**

1ï¸âƒ£ **Retention Based on Time** (Máº·c Ä‘á»‹nh)

- Message sáº½ bá»‹ xÃ³a sau **má»™t khoáº£ng thá»i gian nháº¥t Ä‘á»‹nh**.
- Cáº¥u hÃ¬nh:
```
log.retention.hours=168  # LÆ°u message trong 7 ngÃ y
```

2ï¸âƒ£ **Retention Based on Size**

- Kafka sáº½ xÃ³a dá»¯ liá»‡u khi kÃ­ch thÆ°á»›c partition vÆ°á»£t quÃ¡ giá»›i háº¡n.
- Cáº¥u hÃ¬nh:
```
log.retention.bytes=1073741824  # LÆ°u tá»‘i Ä‘a 1GB per partition
```
ğŸ“Œ **LÆ°u Ã½:** Náº¿u khÃ´ng cÃ³ **log compaction**, Kafka sáº½ xÃ³a toÃ n bá»™ message sau retention time!