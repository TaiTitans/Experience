
---
## âœ… **Consumer lÃ  gÃ¬?**

- **Consumer** lÃ  thÃ nh pháº§n **Ä‘á»c message tá»« Kafka topic** vÃ  xá»­ lÃ½ dá»¯ liá»‡u.
- Kafka sá»­ dá»¥ng **pull-based model** â†’ Consumer **chá»§ Ä‘á»™ng** láº¥y message thay vÃ¬ Kafka Ä‘áº©y message Ä‘áº¿n nÃ³.
- Má»™t Consumer cÃ³ thá»ƒ Ä‘á»c dá»¯ liá»‡u tá»« **nhiá»u partition cá»§a má»™t topic**.

---

## âœ… **CÃ¡ch hoáº¡t Ä‘á»™ng cá»§a Consumer**

1. Consumer káº¿t ná»‘i Ä‘áº¿n **Kafka Broker**.
2. Consumer Ä‘Äƒng kÃ½ Ä‘á»c message tá»« má»™t **topic**.
3. Consumer láº¥y dá»¯ liá»‡u tá»« **partition** theo cÆ¡ cháº¿ **pull**.
4. Sau khi xá»­ lÃ½ message, Consumer cÃ³ thá»ƒ **commit offset** Ä‘á»ƒ Ä‘Ã¡nh dáº¥u message Ä‘Ã£ Ä‘á»c.

**VÃ­ dá»¥:**  
Consumer Ä‘á»c dá»¯ liá»‡u tá»« topic `order-topic`:
```java
Properties props = new Properties();
props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
props.put(ConsumerConfig.GROUP_ID_CONFIG, "order-group");
props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");

KafkaConsumer<String, String> consumer = new KafkaConsumer<>(props);
consumer.subscribe(Collections.singletonList("order-topic"));

while (true) {
    ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(100));
    for (ConsumerRecord<String, String> record : records) {
        System.out.println("Received: " + record.value());
    }
    consumer.commitSync(); // Commit offset sau khi xá»­ lÃ½ xong
}
```
ğŸš€ **Giáº£i thÃ­ch:**

- `AUTO_OFFSET_RESET_CONFIG = "earliest"` â†’ Äá»c tá»« Ä‘áº§u topic náº¿u chÆ°a cÃ³ offset.
- `consumer.poll()` â†’ Láº¥y message tá»« Kafka.
- `consumer.commitSync()` â†’ XÃ¡c nháº­n Ä‘Ã£ xá»­ lÃ½ message.

## âœ… **Offset trong Kafka - CÃ¡ch Consumer theo dÃµi message Ä‘Ã£ Ä‘á»c**

Kafka sá»­ dá»¥ng **offset** Ä‘á»ƒ Ä‘Ã¡nh dáº¥u vá»‹ trÃ­ message mÃ  Consumer Ä‘Ã£ Ä‘á»c:

- Offset lÃ  **má»™t sá»‘ nguyÃªn tÄƒng dáº§n** trong partition.
- Consumer cÃ³ thá»ƒ **commit offset** Ä‘á»ƒ Ä‘Ã¡nh dáº¥u message Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½.

CÃ³ 2 kiá»ƒu commit offset:

1. **Manual Commit (Khuyáº¿n nghá»‹)** â†’ Tá»± commit sau khi xá»­ lÃ½ xong.
```java
consumer.commitSync(); // Commit ngay sau khi xá»­ lÃ½ message
```

**Auto Commit** (KhÃ´ng khuyáº¿n nghá»‹ náº¿u cáº§n Ä‘áº£m báº£o tÃ­nh chÃ­nh xÃ¡c)
```java
props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, "true");
```

âš  **LÆ°u Ã½:** Náº¿u Consumer crash trÆ°á»›c khi commit offset, nÃ³ cÃ³ thá»ƒ Ä‘á»c láº¡i message tá»« Kafka.


# **6ï¸âƒ£ Consumer Group trong Kafka**

## âœ… **Consumer Group lÃ  gÃ¬?**

- Consumer Group lÃ  **táº­p há»£p nhiá»u Consumer cÃ¹ng Ä‘á»c message tá»« má»™t topic**.
- Kafka sá»­ dá»¥ng Consumer Group Ä‘á»ƒ **load balancing** vÃ  **scale horizontally**.
- **Má»—i partition chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi 1 consumer trong group**, nhÆ°ng **má»™t consumer cÃ³ thá»ƒ Ä‘á»c nhiá»u partition**.

---

## âœ… **CÃ¡ch hoáº¡t Ä‘á»™ng cá»§a Consumer Group**

Giáº£ sá»­ topic `order-topic` cÃ³ 3 partition (`P0, P1, P2`):

|**Scenario**|**Consumer Group "order-group"**|**Consumer Assignment**|
|---|---|---|
|**1 Consumer**|`C1`|`C1` Ä‘á»c tá»« `P0, P1, P2`|
|**2 Consumers**|`C1, C2`|`C1` Ä‘á»c tá»« `P0, P1`, `C2` Ä‘á»c tá»« `P2`|
|**3 Consumers**|`C1, C2, C3`|`C1 â†’ P0`, `C2 â†’ P1`, `C3 â†’ P2`|
|**4 Consumers**|`C1, C2, C3, C4`|`C4` khÃ´ng cÃ³ partition Ä‘á»ƒ Ä‘á»c!|

ğŸš€ **Khi Consumer Group cÃ³ nhiá»u Consumer hÆ¡n sá»‘ partition, má»™t Consumer sáº½ khÃ´ng nháº­n Ä‘Æ°á»£c dá»¯ liá»‡u!**

## âœ… **Táº¡o Consumer Group trong Kafka**

### ğŸ”¹ **DÃ¹ng Kafka CLI**

```bash
kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group order-group
```

ğŸ”¹ **Java Code - Consumer vá»›i Group ID**
```java
props.put(ConsumerConfig.GROUP_ID_CONFIG, "order-group"); // Group ID
KafkaConsumer<String, String> consumer = new KafkaConsumer<>(props);
consumer.subscribe(Collections.singletonList("order-topic"));
```

ğŸ’¡ **Kafka Ä‘áº£m báº£o ráº±ng má»—i partition chá»‰ cÃ³ 1 consumer trong group xá»­ lÃ½, giÃºp load balancing**.


## âœ… **Rebalancing - PhÃ¢n phá»‘i láº¡i partition khi Consumer thay Ä‘á»•i**

- Khi cÃ³ **consumer má»›i tham gia hoáº·c rá»i khá»i group**, Kafka sáº½ **phÃ¢n phá»‘i láº¡i partition** â†’ Gá»i lÃ  **rebalancing**.
- Rebalancing cÃ³ thá»ƒ gÃ¢y **giÃ¡n Ä‘oáº¡n táº¡m thá»i** khi Consumer Group Ä‘ang xá»­ lÃ½ dá»¯ liá»‡u.

**CÃ¡ch giáº£m giÃ¡n Ä‘oáº¡n do Rebalancing:**
**Sticky Assignor** â†’ Giá»¯ Consumer gáº¯n vá»›i partition cÅ©.
```java
props.put(ConsumerConfig.PARTITION_ASSIGNMENT_STRATEGY_CONFIG, "org.apache.kafka.clients.consumer.StickyAssignor");
```

**Static Group Membership** â†’ Giá»¯ tráº¡ng thÃ¡i Consumer khi restart.
```java
props.put(ConsumerConfig.GROUP_INSTANCE_ID_CONFIG, "consumer-1");
```
## **TÃ³m táº¯t Consumer & Consumer Group**

|**Má»¥c**|**Consumer**|**Consumer Group**|
|---|---|---|
|**Vai trÃ²**|Äá»c message tá»« Kafka|Táº­p há»£p Consumer xá»­ lÃ½ dá»¯ liá»‡u song song|
|**CÃ¡ch Ä‘á»c dá»¯ liá»‡u**|`pull-based model`|PhÃ¢n phá»‘i message giá»¯a Consumer trong nhÃ³m|
|**Load Balancing**|KhÃ´ng|CÃ³|
|**Scaling**|Äá»c tá»« nhiá»u partition|ThÃªm Consumer Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ xá»­ lÃ½|
|**Offset**|Theo dÃµi vá»‹ trÃ­ Ä‘Ã£ Ä‘á»c|ÄÆ°á»£c quáº£n lÃ½ chung trong Group|

ğŸš€ **Tiáº¿p theo: Zookeeper & KRaft - CÃ¡ch Kafka quáº£n lÃ½ metadata!**



